<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale-1.0">
    <title>ig0 webvm</title>
    
    <!-- LOAD EMULATOR (Stable Version) -->
    <script src="https://unpkg.com/v86@0.2.1/build/libv86.js"></script>

    <style>
        /* Only essential CSS for the emulator screen size */
        #screen_container {
            display: none; /* Hidden until started */
            width: 720px;
            height: 400px;
            border: 1px solid #000;
            background-color: #000;
        }

        /* Ensure the canvas fills the container */
        #screen_container canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        #system-log {
            width: 100%;
            height: 150px;
            background: #f0f0f0;
            border: 1px solid #ccc;
            font-family: monospace;
            font-size: 12px;
            overflow-y: scroll;
            margin-top: 20px;
            padding: 5px;
        }

        fieldset {
            margin-bottom: 15px;
            border: 1px solid #ccc;
            padding: 10px;
        }

        legend {
            font-weight: bold;
        }

        .setting-row {
            margin-bottom: 8px;
        }
    </style>
</head>
<body>

    <h1>ig0 webvm</h1>
    <p>x86 Virtual Machine / Browser-based</p>
    <hr>
    
    <!-- DRIVES SECTION -->
    <fieldset>
        <legend>1. Drives</legend>
        <div class="setting-row">
            <label>CD-ROM Image (.iso):</label><br>
            <input type="file" id="iso-file" accept=".iso">
        </div>
        <div class="setting-row">
            <label>Floppy Image (.img) [Optional]:</label><br>
            <input type="file" id="floppy-file" accept=".img">
        </div>
    </fieldset>

    <!-- HARDWARE SETTINGS -->
    <fieldset>
        <legend>2. Hardware Settings</legend>
        
        <div class="setting-row">
            <label for="ram-select">System Memory (RAM):</label>
            <select id="ram-select">
                <option value="67108864">64 MB</option>
                <option value="134217728" selected>128 MB (Recommended)</option>
                <option value="268435456">256 MB</option>
                <option value="536870912">512 MB (May be slow)</option>
            </select>
        </div>

        <div class="setting-row">
            <label for="vram-select">Video Memory (VRAM):</label>
            <select id="vram-select">
                <option value="2097152">2 MB</option>
                <option value="4194304">4 MB</option>
                <option value="8388608" selected>8 MB</option>
                <option value="16777216">16 MB</option>
            </select>
        </div>

        <div class="setting-row">
            <label for="boot-order">Boot Priority:</label>
            <select id="boot-order">
                <option value="213">CD-ROM / Hard Drive / Floppy</option>
                <option value="312">CD-ROM / Floppy / Hard Drive</option>
                <option value="123">Floppy / CD-ROM / Hard Drive</option>
            </select>
        </div>
    </fieldset>
    
    <!-- CONTROLS -->
    <div>
        <label>3. Action:</label><br>
        <button id="start-button" disabled>Load Engine...</button>
        <button id="stop-button" disabled>Stop VM</button>
        <button id="fullscreen-button" disabled>Fullscreen</button>
    </div>

    <br>
    <div id="status-area">System: Waiting for library...</div>
    <br>

    <!-- VM SCREEN -->
    <div id="screen_container">
        <div style="white-space: pre; font: 14px monospace; line-height: 14px"></div>
        <canvas style="display: none"></canvas>
    </div>

    <!-- DEBUG LOG -->
    <textarea id="system-log" readonly></textarea>

    <script>
        const startBtn = document.getElementById('start-button');
        const stopBtn = document.getElementById('stop-button');
        const fullBtn = document.getElementById('fullscreen-button');
        const isoInput = document.getElementById('iso-file');
        const floppyInput = document.getElementById('floppy-file');
        const ramSelect = document.getElementById('ram-select');
        const vramSelect = document.getElementById('vram-select');
        const bootSelect = document.getElementById('boot-order');
        const screen = document.getElementById('screen_container');
        const statusArea = document.getElementById('status-area');
        const sysLog = document.getElementById('system-log');
        
        let emulator = null;

        function log(msg) {
            const time = new Date().toLocaleTimeString();
            sysLog.value += `[${time}] ${msg}\n`;
            sysLog.scrollTop = sysLog.scrollHeight;
        }

        // --- 1. Library Loader Check ---
        function checkLib() {
            if (typeof window.V86Starter !== 'undefined') {
                statusArea.innerText = "System: Engine Ready. Configure settings and start.";
                startBtn.innerText = "Start System";
                startBtn.disabled = false;
                log("Library V86Starter loaded successfully.");
            } else {
                setTimeout(checkLib, 500);
            }
        }
        
        log("Checking for v86 library...");
        checkLib();

        // --- 2. Start Logic ---
        startBtn.onclick = function() {
            // Basic validation
            if (!isoInput.files.length && !floppyInput.files.length) {
                statusArea.innerText = "ERROR: Please select at least one drive image (ISO or Floppy).";
                log("Error: No boot media selected.");
                return;
            }
            
            // Lock UI
            startBtn.disabled = true;
            stopBtn.disabled = false;
            fullBtn.disabled = false;
            isoInput.disabled = true;
            floppyInput.disabled = true;
            ramSelect.disabled = true;
            vramSelect.disabled = true;
            bootSelect.disabled = true;
            
            screen.style.display = 'block';
            statusArea.innerText = "System: Initializing Virtual Machine...";

            try {
                // Prepare config object
                const config = {
                    wasm_path: "https://unpkg.com/v86@0.2.1/build/v86.wasm",
                    memory_size: parseInt(ramSelect.value),
                    vga_memory_size: parseInt(vramSelect.value),
                    screen_container: screen,
                    bios: { url: "https://unpkg.com/v86@0.2.1/bios/seabios.bin" },
                    vga_bios: { url: "https://unpkg.com/v86@0.2.1/bios/vgabios.bin" },
                    boot_order: parseInt(bootSelect.value),
                    autostart: true
                };

                // Add ISO if present
                if (isoInput.files.length) {
                    config.cdrom = { url: URL.createObjectURL(isoInput.files[0]) };
                    log(`Mounting CD-ROM: ${isoInput.files[0].name}`);
                }

                // Add Floppy if present
                if (floppyInput.files.length) {
                    config.fda = { url: URL.createObjectURL(floppyInput.files[0]) };
                    log(`Mounting Floppy: ${floppyInput.files[0].name}`);
                }

                log(`Settings: RAM=${config.memory_size / 1024 / 1024}MB, VRAM=${config.vga_memory_size / 1024 / 1024}MB`);
                log("Initializing V86Starter...");
                
                // Initialize v86
                emulator = new window.V86Starter(config);

                // Listeners
                emulator.add_listener("download-progress", function(e) {
                    const prog = Math.round((e.loaded / e.total) * 100);
                    if (!isNaN(prog)) {
                        statusArea.innerText = "System: Downloading Engine Core... " + prog + "%";
                        if (prog % 20 === 0) log(`Download progress: ${prog}%`);
                    }
                });

                emulator.add_listener("emulator-ready", function() {
                    statusArea.innerText = "System: VM RUNNING. Click screen to capture mouse (Esc to exit).";
                    log("Event: emulator-ready. System is live.");
                });
                
                emulator.add_listener("emulator-stopped", function() {
                    statusArea.innerText = "System: VM HALTED.";
                    log("Event: emulator-stopped.");
                });

            } catch (err) {
                statusArea.innerText = "CRITICAL ERROR: " + err.message;
                log("CRITICAL EXCEPTION: " + err.message);
                console.error(err);
                resetUI();
            }
        };

        // --- 3. Stop Logic ---
        stopBtn.onclick = function() {
            log("User requested stop.");
            if (emulator) {
                try {
                    emulator.stop();
                    emulator.destroy();
                } catch(e) {
                    log("Error during stop: " + e.message);
                }
                emulator = null;
            }
            resetUI();
        };

        // --- 4. Fullscreen Logic ---
        fullBtn.onclick = function() {
            if (!screen) return;
            
            if (screen.requestFullscreen) {
                screen.requestFullscreen();
            } else if (screen.mozRequestFullScreen) { /* Firefox */
                screen.mozRequestFullScreen();
            } else if (screen.webkitRequestFullscreen) { /* Chrome, Safari & Opera */
                screen.webkitRequestFullscreen();
            } else if (screen.msRequestFullscreen) { /* IE/Edge */
                screen.msRequestFullscreen();
            }
        };

        function resetUI() {
            startBtn.disabled = false;
            stopBtn.disabled = true;
            fullBtn.disabled = true;
            isoInput.disabled = false;
            floppyInput.disabled = false;
            ramSelect.disabled = false;
            vramSelect.disabled = false;
            bootSelect.disabled = false;
            
            screen.style.display = 'none';
            screen.innerHTML = '<div style="white-space: pre; font: 14px monospace; line-height: 14px"></div><canvas style="display: none"></canvas>';
            
            if (!statusArea.innerText.includes("ERROR")) {
                statusArea.innerText = "System: Halted. Ready for new session.";
            }
            log("UI Reset.");
        }
    </script>
</body>
</html>
